env:
    PUBLIC_VERSION_NUMBER: '0.5'
    PORTABLE_DIR: ${{ github.workspace }}/output/installer
    INSTALLBUILDER_DIR: ib/app
    INSTALLBUILDER_URL: https://installbuilder.com/installbuilder-professional-22.10.0-linux-x64-installer.run

name: Build  'pilot-november-2022 with Installer (Linux)'
on: [workflow_dispatch]  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:   
      - name: Install the InstalBuilder
        shell: bash
        run: |
            curl -L ${{ env.INSTALLBUILDER_URL }} --output ib.run
            chmod +x ib.run
            ./ib.run --mode unattended --prefix ${{ env.INSTALLBUILDER_DIR }}     
            ${{ env.INSTALLBUILDER_DIR }}/bin/builder --version
            echo "INSTALLER_SRC_PREFIX=$(pwd)" >> $GITHUB_ENV
            echo "INSTALLER_BIN_PREFIX=${{ env.PORTABLE_DIR }}" >> $GITHUB_ENV            
      - uses: actions/checkout@v3
        with:
           path: maco_content_2023_packages
      - name: Checkout runtimes
        uses: actions/checkout@v3
        with:
          repository: kroehne/maco_content_2023_runtimes    
          token: ${{ secrets.MACO_CONTENT_CHECKOUT}}  
          path: maco_content_2023_runtimes
      - name: Checkout content in branch 'pilot-november-2022'
        uses: actions/checkout@v3
        with:
          repository: kroehne/maco_content_2023    
          token: ${{ secrets.MACO_CONTENT_CHECKOUT}}  
          path: maco_content_2023
          ref: pilot-november-2022
      - name: Prepare folders
        run: |      
         mkdir -p maco_content_2023/items/cover
         cp maco_content_2023/cover/*.zip maco_content_2023/items/cover   
         mkdir -p maco_content_2023/runtimes
         cp -r maco_content_2023_runtimes/9.8.0 maco_content_2023/runtimes
         mkdir -p output/ 
         cp -r maco_content_2023/materials output/
         mkdir docs
         mkdir software-driven
         ls -R
      - name: Checkout Alea / Testapp 
        run: |
          git clone --branch develop https://ukroehne:${{ secrets.CHECKINKEYMACO }}@bitbucket.org/software-driven/dipf-alea.git software-driven/dipf-alea
          git clone --branch develop https://ukroehne:${{ secrets.CHECKINKEYMACO }}@bitbucket.org/software-driven/dipf-testapp.git software-driven/dipf-testapp
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x
          dotnet-quality: 'preview'     
      - name: Build output
        run: |
          cd software-driven
          cd dipf-alea
          cd Alea.Prepare
          dotnet run --project ./Alea.Prepare.csproj -- -w false -c ../../../maco_content_2023/codebooks/ -d ../../../output/ -i  ../../../maco_content_2023/items/ -r ../../../maco_content_2023/runtimes/ -s ../../../output/ > "../../../output/alea_preopare_log.txt"
          cd ..
          cd ..
          cd ..        
      - name: Overwrite content to create installer 
        run: | 
         rsync -avh output/ ./software-driven/dipf-alea/Installer/Content/ --delete --exclude=/.git
      - name: Try to build 
        run: |         
          cd software-driven
          cd dipf-alea
          cd Alea.Desktop
          dotnet publish -c Release -p:PublishProfile=Properties/PublishProfiles/FolderProfile.win-x64.pubxml
          cd ..
          cd ..
          cd ..                  
      - name: Create installer package
        shell: bash
        env:
         IB_LICENSE: ${{ secrets.INSTALLER_LICENSE }}
        run: |
            ls -lR
            echo "$IB_LICENSE" > lic.xml
            ${{ env.INSTALLBUILDER_DIR }}/bin/builder build ./software-driven/dipf-alea/Installer/AleaDesktop-Pilot.xml windows-x64 \
                --license lic.xml \
                --setvars project.outputDirectory=$(pwd) \
                --setvars project.version=$PUBLIC_VERSION_NUMBER \
                --setvars project.fullName="AleaDesktop (MSK-OC) -- Pilot November 2022" \
                --setvars vendor="DIPF / erstellt durch Software Driven UG" 
            ls -lR
      - name: Upload package artifact
        uses: actions/upload-artifact@v1
        with:
          name: AleaDesktopMskOC-${{ env.PUBLIC_VERSION_NUMBER }}-windows-x64-installer.exe 
          path: output/installer/AleaDesktopMskOC-${{ env.PUBLIC_VERSION_NUMBER }}-windows-x64-installer.exe 
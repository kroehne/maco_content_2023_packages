name: Build  'pilot-november-2022'
on: [workflow_dispatch]  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:    
      - uses: actions/checkout@v3
      - name: Checkout runtimes
        uses: actions/checkout@v3
        with:
          repository: kroehne/maco_content_2023_runtimes    
          token: ${{ secrets.MACO_CONTENT_CHECKOUT}}  
          path: maco_content_2023_runtimes
      - name: Checkout content in branch 'pilot-november-2022'
        uses: actions/checkout@v3
        with:
          repository: kroehne/maco_content_2023    
          token: ${{ secrets.MACO_CONTENT_CHECKOUT}}  
          path: maco_content_2023
          ref: pilot-november-2022
      - name: Prepare folders
        run: |      
         mkdir -p maco_content_2023/items/cover
         cp maco_content_2023/cover/*.zip maco_content_2023/items/cover   
         mkdir -p maco_content_2023/runtimes
         cp -r maco_content_2023_runtimes/9.8.0 maco_content_2023/runtimes
         mkdir -p output/ 
         cp -r maco_content_2023/materials output/
         mkdir docs
         ls -R
      - name: Checkout Alea / Testapp 
        run: |
          git clone --branch develop https://ukroehne:ATBBzUC2KPqFUnLGqJymY4QranuUB6F96EB9@bitbucket.org/software-driven/dipf-alea.git
          git clone --branch develop https://ukroehne:ATBBzUC2KPqFUnLGqJymY4QranuUB6F96EB9@bitbucket.org/software-driven/dipf-testapp.git          
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x
          dotnet-quality: 'preview'     
      - name: Build output
        run: |
          cd dipf-alea
          cd Alea.Prepare
          dotnet run --project ./Alea.Prepare.csproj -- -w false -c ../../maco_content_2023/codebooks/ -d ../../output/ -i  ../../maco_content_2023/items/ -r ../../maco_content_2023/runtimes/ -s ../../output/ > "../../output/alea_preopare_log.txt"
          cd ..
          cd ..
      - name: Create output zip
        run: zip -r -q docs/pilot-november-2022.zip output/ 
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs/ 
      - name: Checkout Content 
        run: |
          git clone --branch pilot-november-2022 https://ukroehne:ATBBzUC2KPqFUnLGqJymY4QranuUB6F96EB9@bitbucket.org/software-driven/dipf-alea-content.git content
      - name: Overwrite content
        run: |      
         mkdir -p output/ content/
         ls -R
